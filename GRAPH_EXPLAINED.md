# ReviewOps å·¥ä½œæµè¯¦è§£ï¼šç»™åˆå­¦è€…çš„å®Œæ•´æŒ‡å—

> æœ¬æ–‡æ¡£ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Š ReviewOps çš„å·¥ä½œæµæœºåˆ¶ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ä»£ç ã€‚

---

## 1. ReviewState çš„"è¿½åŠ æ¨¡å¼" vs "è¦†ç›–æ¨¡å¼"

### 1.1 ä»€ä¹ˆæ˜¯"è¿½åŠ æ¨¡å¼"å’Œ"è¦†ç›–æ¨¡å¼"ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ä¸ª**ç¬”è®°æœ¬**ï¼ˆè¿™å°±æ˜¯ `ReviewState`ï¼‰ï¼Œé‡Œé¢æœ‰å¾ˆå¤šé¡µï¼ˆå­—æ®µï¼‰ï¼š

- **è¿½åŠ æ¨¡å¼**ï¼šå°±åƒåœ¨æ—¥è®°æœ¬ä¸Š**ç»§ç»­å†™**ï¼Œæ–°å†…å®¹**è¿½åŠ **åˆ°æ—§å†…å®¹åé¢
- **è¦†ç›–æ¨¡å¼**ï¼šå°±åƒåœ¨è‰ç¨¿çº¸ä¸Š**é‡æ–°å†™**ï¼Œæ–°å†…å®¹**æ›¿æ¢**æ‰æ—§å†…å®¹

### 1.2 åœ¨å“ªé‡Œå®šä¹‰çš„ï¼Ÿ

**ç­”æ¡ˆï¼šåœ¨ `src/state.py` çš„ `reducer` å‡½æ•°ä¸­ï¼**

è®©æˆ‘ä»¬çœ‹çœ‹ä»£ç ï¼š

```python
# src/state.py

def reducer(state: ReviewState, update: ReviewState) -> ReviewState:
    """åˆå¹¶çŠ¶æ€æ›´æ–°"""
    merged = state.copy()  # å…ˆå¤åˆ¶ä¸€ä»½æ—§çŠ¶æ€
    
    # ========== è¿½åŠ æ¨¡å¼ ==========
    if "logs" in update:
        # logs æ˜¯è¿½åŠ çš„ï¼šæ—§æ—¥å¿— + æ–°æ—¥å¿—
        merged["logs"] = state.get("logs", []) + update.get("logs", [])
        # ä¾‹å¦‚ï¼š[æ—§æ—¥å¿—1, æ—§æ—¥å¿—2] + [æ–°æ—¥å¿—3] = [æ—§æ—¥å¿—1, æ—§æ—¥å¿—2, æ–°æ—¥å¿—3]
    
    if "processed_ids" in update:
        # processed_ids æ˜¯å¹¶é›†åˆå¹¶ï¼ˆå»é‡ï¼‰
        existing_ids = set(state.get("processed_ids", []))
        new_ids = set(update.get("processed_ids", []))
        merged["processed_ids"] = list(existing_ids | new_ids)
        # ä¾‹å¦‚ï¼š[1, 2] | [2, 3] = [1, 2, 3]ï¼ˆå»é‡ï¼‰
    
    # ========== è¦†ç›–æ¨¡å¼ ==========
    if "raw_reviews" in update:
        # raw_reviews æ˜¯è¦†ç›–çš„ï¼šç›´æ¥ç”¨æ–°å€¼æ›¿æ¢æ—§å€¼
        merged["raw_reviews"] = update.get("raw_reviews", [])
        # ä¾‹å¦‚ï¼šæ—§å€¼ [è¯„è®º1, è¯„è®º2] è¢«æ–°å€¼ [è¯„è®º3, è¯„è®º4] å®Œå…¨æ›¿æ¢
    
    if "critical_reviews" in update:
        merged["critical_reviews"] = update.get("critical_reviews", [])
    
    if "rag_analysis_results" in update:
        merged["rag_analysis_results"] = update.get("rag_analysis_results", [])
    
    if "action_plans" in update:
        merged["action_plans"] = update.get("action_plans", [])
    
    return merged
```

### 1.3 å­—æ®µåˆ†ç±»æ€»ç»“

| å­—æ®µå | æ¨¡å¼ | åŸå›  | ç¤ºä¾‹ |
|--------|------|------|------|
| **`logs`** | âœ… **è¿½åŠ ** | æ—¥å¿—éœ€è¦ä¿ç•™å†å²ï¼Œä¸èƒ½ä¸¢å¤± | `[æ—§æ—¥å¿—] + [æ–°æ—¥å¿—]` |
| **`processed_ids`** | âœ… **å¹¶é›†åˆå¹¶** | ID é›†åˆéœ€è¦å»é‡ï¼Œä¸èƒ½é‡å¤å¤„ç† | `[1,2] | [2,3] = [1,2,3]` |
| **`raw_reviews`** | âŒ **è¦†ç›–** | æ¯æ¬¡ Monitor ç”Ÿæˆçš„éƒ½æ˜¯"æ–°ä¸€æ‰¹"è¯„è®ºï¼Œæ›¿æ¢æ—§çš„ | `[è¯„è®º1,2]` â†’ `[è¯„è®º3,4]` |
| **`critical_reviews`** | âŒ **è¦†ç›–** | Filter ç­›é€‰çš„æ˜¯å½“å‰æ‰¹æ¬¡çš„è¯„è®ºï¼Œæ›¿æ¢æ—§çš„ | `[é«˜å±1,2]` â†’ `[é«˜å±3,4]` |
| **`rag_analysis_results`** | âŒ **è¦†ç›–** | RAG åˆ†æçš„æ˜¯å½“å‰æ‰¹æ¬¡çš„è¯„è®ºï¼Œæ›¿æ¢æ—§çš„ | `[ç»“æœ1,2]` â†’ `[ç»“æœ3,4]` |
| **`action_plans`** | âŒ **è¦†ç›–** | Action ç”Ÿæˆçš„æ˜¯å½“å‰æ‰¹æ¬¡çš„ç»“æœï¼Œæ›¿æ¢æ—§çš„ | `[è¡ŒåŠ¨1,2]` â†’ `[è¡ŒåŠ¨3,4]` |

### 1.4 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

**è¿½åŠ æ¨¡å¼ï¼ˆlogs, processed_idsï¼‰**ï¼š
- **logs**: éœ€è¦ä¿ç•™å®Œæ•´çš„æ‰§è¡Œå†å²ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œè¿½è¸ª
- **processed_ids**: éœ€è¦ç´¯ç§¯æ‰€æœ‰å·²å¤„ç†çš„IDï¼Œç¡®ä¿å¹‚ç­‰æ€§ï¼ˆä¸ä¼šé‡å¤å¤„ç†ï¼‰

**è¦†ç›–æ¨¡å¼ï¼ˆå…¶ä»–å­—æ®µï¼‰**ï¼š
- è¿™äº›å­—æ®µä»£è¡¨çš„æ˜¯**å½“å‰æ‰¹æ¬¡**çš„æ•°æ®ï¼Œä¸æ˜¯å†å²ç´¯ç§¯
- æ¯æ¬¡å·¥ä½œæµè¿è¡Œï¼Œéƒ½æ˜¯å¤„ç†"æ–°çš„ä¸€æ‰¹"æ•°æ®ï¼Œæ‰€ä»¥åº”è¯¥æ›¿æ¢ï¼Œè€Œä¸æ˜¯è¿½åŠ 
- ä¾‹å¦‚ï¼š`raw_reviews` æ˜¯"è¿™æ¬¡æ–°å‘ç°çš„è¯„è®º"ï¼Œä¸æ˜¯"æ‰€æœ‰å†å²è¯„è®º"

---

## 2. å®Œæ•´å·¥ä½œæµæµç¨‹å›¾ï¼ˆASCII å›¾ï¼‰

è®©æˆ‘ç”¨ ASCII å›¾ç”»å‡ºæ•´ä¸ªæµç¨‹ï¼Œå¹¶æ ‡æ³¨æ¯ä¸ªæ­¥éª¤ State çš„å˜åŒ–ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆå§‹çŠ¶æ€ (Initial State)                      â”‚
â”‚  State = {                                                       â”‚
â”‚    raw_reviews: [],                                             â”‚
â”‚    critical_reviews: [],                                        â”‚
â”‚    rag_analysis_results: [],                                    â”‚
â”‚    action_plans: [],                                            â”‚
â”‚    logs: [],                                                    â”‚
â”‚    processed_ids: [101, 102, ...]  â† ä¿ç•™å†å²å·²å¤„ç†ID           â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    [ç”¨æˆ·ç‚¹å‡»"è¿è¡Œæ™ºèƒ½å·¥ä½œæµ"]
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¡ Monitor Node (node_monitor)                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  è¾“å…¥: state.processed_ids = [101, 102, ...]                   â”‚
â”‚                                                                  â”‚
â”‚  å¤„ç†:                                                           â”‚
â”‚    1. ä» MOCK_DATA_POOL éšæœºé‡‡æ ·                                â”‚
â”‚    2. ç”Ÿæˆå”¯ä¸€ID: base_id + æ—¶é—´æˆ³ + éšæœºæ•°                     â”‚
â”‚    3. æ£€æŸ¥ processed_idsï¼Œè·³è¿‡å·²å¤„ç†çš„                          â”‚
â”‚    4. ç”Ÿæˆæ–°è¯„è®ºåˆ—è¡¨                                             â”‚
â”‚                                                                  â”‚
â”‚  è¾“å‡º:                                                           â”‚
â”‚    {                                                             â”‚
â”‚      raw_reviews: [è¯„è®ºA, è¯„è®ºB],      â† è¦†ç›–æ¨¡å¼               â”‚
â”‚      processed_ids: [201, 202],        â† å¹¶é›†åˆå¹¶ï¼ˆè¿½åŠ æ–°IDï¼‰   â”‚
â”‚      logs: ["ğŸ“… æ£€æµ‹åˆ° 2 æ¡æ–°å¢è¯„è®º"]  â† è¿½åŠ æ¨¡å¼               â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚  State å˜åŒ–:                                                     â”‚
â”‚    âœ… raw_reviews: [] â†’ [è¯„è®ºA, è¯„è®ºB]  (è¦†ç›–)                  â”‚
â”‚    âœ… processed_ids: [101,102] â†’ [101,102,201,202]  (å¹¶é›†)      â”‚
â”‚    âœ… logs: [] â†’ ["ğŸ“… æ£€æµ‹åˆ° 2 æ¡æ–°å¢è¯„è®º"]  (è¿½åŠ )             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” Filter Node (node_filter)                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  è¾“å…¥: state.raw_reviews = [è¯„è®ºA, è¯„è®ºB]                       â”‚
â”‚                                                                  â”‚
â”‚  å¤„ç†:                                                           â”‚
â”‚    1. æ„å»ºç­›é€‰ Promptï¼ˆåŒ…å«æ‰€æœ‰è¯„è®ºï¼‰                           â”‚
â”‚    2. è°ƒç”¨ LLM è¿›è¡Œè¯­ä¹‰ç­›é€‰                                      â”‚
â”‚    3. è§£æ JSONï¼Œæå–é«˜å±è¯„è®ºID                                 â”‚
â”‚    4. åŒ¹é…è¯„è®ºï¼ˆæ”¯æŒå®Œæ•´IDå’Œbase_idåŒ¹é…ï¼‰                       â”‚
â”‚                                                                  â”‚
â”‚  è¾“å‡º:                                                           â”‚
â”‚    {                                                             â”‚
â”‚      critical_reviews: [è¯„è®ºA],        â† è¦†ç›–æ¨¡å¼ï¼ˆç­›é€‰ç»“æœï¼‰    â”‚
â”‚      logs: ["ğŸ” ç­›é€‰å‡º 1 æ¡é«˜å±è¯„è®º"]  â† è¿½åŠ æ¨¡å¼               â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚  State å˜åŒ–:                                                     â”‚
â”‚    âœ… critical_reviews: [] â†’ [è¯„è®ºA]  (è¦†ç›–)                    â”‚
â”‚    âœ… logs: [æ—§æ—¥å¿—] â†’ [æ—§æ—¥å¿—, "ğŸ” ç­›é€‰å‡º 1 æ¡é«˜å±è¯„è®º"]  (è¿½åŠ )â”‚
â”‚    âš ï¸ raw_reviews: [è¯„è®ºA, è¯„è®ºB]  (ä¿æŒä¸å˜ï¼Œä½†ä¸å†ä½¿ç”¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    [æ¡ä»¶åˆ¤æ–­: æ˜¯å¦æœ‰é«˜å±è¯„è®º?]
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   â”‚
            [æœ‰é«˜å±è¯„è®º]          [æ— é«˜å±è¯„è®º]
                    â”‚                   â”‚
                    â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“„ RAG Node (node_rag_analysis)â”‚   â”‚  ç›´æ¥ç»“æŸ (END)      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚                      â”‚
â”‚  è¾“å…¥: state.critical_reviews   â”‚   â”‚  State ä¿æŒ Filter   â”‚
â”‚        = [è¯„è®ºA]                â”‚   â”‚  èŠ‚ç‚¹çš„è¾“å‡ºä¸å˜      â”‚
â”‚                                  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  å¤„ç†:                           â”‚
â”‚    1. åˆå§‹åŒ–å‘é‡åº“ï¼ˆChromaDBï¼‰   â”‚
â”‚    2. å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢ç›¸å…³æ–‡æ¡£     â”‚
â”‚    3. è¿‡æ»¤ä½ç›¸å…³æ€§ç»“æœ           â”‚
â”‚    4. ç»„è£… RAG Prompt           â”‚
â”‚    5. è°ƒç”¨ LLM è¿›è¡Œå½’å› åˆ†æ      â”‚
â”‚                                  â”‚
â”‚  è¾“å‡º:                           â”‚
â”‚    {                             â”‚
â”‚      rag_analysis_results: [     â”‚
â”‚        {                         â”‚
â”‚          review_id: "201_xxx",   â”‚
â”‚          conclusion: "âš ï¸ äº§å“ç¼ºé™·",â”‚
â”‚          reason: "åˆ†æåŸå› ...",   â”‚
â”‚          evidence: "è¯æ®ç‰‡æ®µ..."  â”‚
â”‚        }                         â”‚
â”‚      ],                          â”‚
â”‚      logs: ["ğŸ“„ å®Œæˆ 1 æ¡å½’å› åˆ†æ"]â”‚
â”‚    }                             â”‚
â”‚                                  â”‚
â”‚  State å˜åŒ–:                     â”‚
â”‚    âœ… rag_analysis_results: [] â†’ â”‚
â”‚       [{ç»“è®º: "âš ï¸ äº§å“ç¼ºé™·", ...}]â”‚
â”‚    âœ… logs: [æ—§æ—¥å¿—] â†’ [æ—§æ—¥å¿—, "ğŸ“„ å®Œæˆ 1 æ¡å½’å› åˆ†æ"]â”‚
â”‚    âš ï¸ critical_reviews: [è¯„è®ºA]  (ä¿æŒä¸å˜ï¼Œä½†ä¸å†ä½¿ç”¨)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¡ Action Node (node_action_gen)                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  è¾“å…¥: state.rag_analysis_results = [{ç»“è®º: "âš ï¸ äº§å“ç¼ºé™·", ...}]â”‚
â”‚                                                                  â”‚
â”‚  å¤„ç†:                                                           â”‚
â”‚    1. æ„å»ºè¡ŒåŠ¨ç”Ÿæˆ Promptï¼ˆåŒ…å«å½’å› ç»“æœï¼‰                        â”‚
â”‚    2. è°ƒç”¨ LLM ç”Ÿæˆ JSON æ ¼å¼çš„è¡ŒåŠ¨å»ºè®®                          â”‚
â”‚    3. éªŒè¯å­—æ®µå®Œæ•´æ€§ï¼ˆaction_type, title, content, priorityï¼‰   â”‚
â”‚    4. è§£æ JSONï¼Œæå–è¡ŒåŠ¨å»ºè®®                                   â”‚
â”‚                                                                  â”‚
â”‚  è¾“å‡º:                                                           â”‚
â”‚    {                                                             â”‚
â”‚      action_plans: [                                            â”‚
â”‚        {                                                         â”‚
â”‚          review_id: "201_xxx",                                  â”‚
â”‚          action_type: "Jira Ticket",                            â”‚
â”‚          title: "ä¿®å¤äº§å“ç¼ºé™·ï¼š...",                            â”‚
â”‚          content: "è¯¦ç»†å†…å®¹...",                                â”‚
â”‚          priority: "High"                                        â”‚
â”‚        }                                                         â”‚
â”‚      ],                                                          â”‚
â”‚      logs: ["ğŸ’¡ ç”Ÿæˆ 1 ä¸ªè¡ŒåŠ¨å»ºè®®"]  â† è¿½åŠ æ¨¡å¼                 â”‚
â”‚    }                                                             â”‚
â”‚                                                                  â”‚
â”‚  State å˜åŒ–:                                                     â”‚
â”‚    âœ… action_plans: [] â†’ [{Jira Ticket, High, ...}]  (è¦†ç›–)    â”‚
â”‚    âœ… logs: [æ—§æ—¥å¿—] â†’ [æ—§æ—¥å¿—, "ğŸ’¡ ç”Ÿæˆ 1 ä¸ªè¡ŒåŠ¨å»ºè®®"]  (è¿½åŠ )  â”‚
â”‚    âš ï¸ rag_analysis_results: [...]  (ä¿æŒä¸å˜ï¼Œä½†ä¸å†ä½¿ç”¨)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ€ç»ˆçŠ¶æ€ (Final State)                        â”‚
â”‚  State = {                                                       â”‚
â”‚    raw_reviews: [è¯„è®ºA, è¯„è®ºB],        â† Monitor çš„è¾“å‡º         â”‚
â”‚    critical_reviews: [è¯„è®ºA],            â† Filter çš„è¾“å‡º         â”‚
â”‚    rag_analysis_results: [{ç»“è®º: "âš ï¸ äº§å“ç¼ºé™·", ...}],          â”‚
â”‚    action_plans: [{Jira Ticket, High, ...}],                    â”‚
â”‚    logs: [                                                        â”‚
â”‚      "ğŸ“… æ£€æµ‹åˆ° 2 æ¡æ–°å¢è¯„è®º",          â† Monitor çš„æ—¥å¿—         â”‚
â”‚      "ğŸ” ç­›é€‰å‡º 1 æ¡é«˜å±è¯„è®º",          â† Filter çš„æ—¥å¿—          â”‚
â”‚      "ğŸ“„ å®Œæˆ 1 æ¡å½’å› åˆ†æ",            â† RAG çš„æ—¥å¿—             â”‚
â”‚      "ğŸ’¡ ç”Ÿæˆ 1 ä¸ªè¡ŒåŠ¨å»ºè®®"             â† Action çš„æ—¥å¿—          â”‚
â”‚    ],                                                             â”‚
â”‚    processed_ids: [101, 102, 201, 202]  â† ç´¯ç§¯æ‰€æœ‰å·²å¤„ç†ID      â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.1 å…³é”®è§‚å¯Ÿç‚¹

1. **æ•°æ®æµè½¬**ï¼š
   - `raw_reviews` â†’ `critical_reviews` â†’ `rag_analysis_results` â†’ `action_plans`
   - æ¯ä¸ªèŠ‚ç‚¹è¯»å–ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºï¼Œç”Ÿæˆè‡ªå·±çš„è¾“å‡º

2. **çŠ¶æ€ç´¯ç§¯**ï¼š
   - `logs` å’Œ `processed_ids` æ˜¯**ç´¯ç§¯çš„**ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¿½åŠ 
   - å…¶ä»–å­—æ®µæ˜¯**æ›¿æ¢çš„**ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”¨æ–°å€¼è¦†ç›–æ—§å€¼

3. **æ¡ä»¶åˆ†æ”¯**ï¼š
   - Filter èŠ‚ç‚¹åï¼Œå¦‚æœæ²¡æœ‰é«˜å±è¯„è®ºï¼Œç›´æ¥ç»“æŸï¼Œè·³è¿‡ RAG å’Œ Action

---

## 3. `compile()` å‡½æ•°åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ

### 3.1 ç®€å•ç†è§£

`compile()` å°±åƒ**æŠŠè®¾è®¡å›¾çº¸å˜æˆçœŸæ­£çš„æœºå™¨**ã€‚

- **è®¾è®¡å›¾çº¸** = `StateGraph`ï¼ˆä½ å®šä¹‰çš„èŠ‚ç‚¹å’Œè¾¹ï¼‰
- **çœŸæ­£çš„æœºå™¨** = `graph_app`ï¼ˆå¯ä»¥è¿è¡Œçš„å·¥ä½œæµï¼‰

### 3.2 è¯¦ç»†è§£é‡Š

è®©æˆ‘ä»¬çœ‹çœ‹ä»£ç ï¼š

```python
# src/graph.py

def build_graph():
    # æ­¥éª¤ 1: åˆ›å»º"è®¾è®¡å›¾çº¸"ï¼ˆStateGraphï¼‰
    workflow = StateGraph(ReviewState)
    
    # æ­¥éª¤ 2: åœ¨å›¾çº¸ä¸Š"ç”»èŠ‚ç‚¹"ï¼ˆæ·»åŠ èŠ‚ç‚¹å‡½æ•°ï¼‰
    workflow.add_node("monitor", node_monitor)
    workflow.add_node("filter", node_filter)
    workflow.add_node("rag_analysis", node_rag_analysis)
    workflow.add_node("action_gen", node_action_gen)
    
    # æ­¥éª¤ 3: åœ¨å›¾çº¸ä¸Š"ç”»ç®­å¤´"ï¼ˆæ·»åŠ è¾¹ï¼‰
    workflow.set_entry_point("monitor")  # å…¥å£ï¼šä» monitor å¼€å§‹
    workflow.add_edge("monitor", "filter")  # monitor â†’ filter
    workflow.add_conditional_edges("filter", should_continue_analysis, {...})  # filter â†’ (æ¡ä»¶åˆ¤æ–­)
    workflow.add_edge("rag_analysis", "action_gen")  # rag_analysis â†’ action_gen
    workflow.add_edge("action_gen", END)  # action_gen â†’ ç»“æŸ
    
    # æ­¥éª¤ 4: ç¼–è¯‘å›¾çº¸ï¼Œå˜æˆå¯è¿è¡Œçš„æœºå™¨
    graph_app = workflow.compile()  # â† è¿™é‡Œï¼
    
    return graph_app
```

### 3.3 `compile()` å†…éƒ¨åšäº†ä»€ä¹ˆï¼Ÿ

**é€šä¿—ç†è§£**ï¼š

1. **éªŒè¯å›¾çº¸**ï¼šæ£€æŸ¥èŠ‚ç‚¹å’Œè¾¹æ˜¯å¦åˆæ³•ï¼ˆä¾‹å¦‚ï¼šæ˜¯å¦æœ‰å…¥å£ç‚¹ï¼Ÿæ˜¯å¦æœ‰å­¤ç«‹èŠ‚ç‚¹ï¼Ÿï¼‰
2. **ä¼˜åŒ–è·¯å¾„**ï¼šè®¡ç®—æœ€çŸ­è·¯å¾„ï¼Œä¼˜åŒ–æ‰§è¡Œé¡ºåº
3. **ç”Ÿæˆæ‰§è¡Œå¼•æ“**ï¼šåˆ›å»ºä¸€ä¸ªå¯ä»¥"è¿è¡Œ"çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡çŸ¥é“ï¼š
   - ä»å“ªä¸ªèŠ‚ç‚¹å¼€å§‹
   - æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œå®Œåï¼Œä¸‹ä¸€æ­¥å»å“ªé‡Œ
   - å¦‚ä½•åˆå¹¶çŠ¶æ€ï¼ˆä½¿ç”¨ `reducer`ï¼‰
   - å¦‚ä½•å¤„ç†æ¡ä»¶åˆ†æ”¯

**æŠ€æœ¯ç»†èŠ‚**ï¼š

```python
# compile() å†…éƒ¨å¤§è‡´åšäº†è¿™äº›äº‹ï¼š

def compile(self):
    # 1. éªŒè¯å›¾ç»“æ„
    self._validate_graph()
    
    # 2. æ„å»ºæ‰§è¡Œè®¡åˆ’
    execution_plan = self._build_execution_plan()
    
    # 3. åˆ›å»ºçŠ¶æ€ç®¡ç†å™¨ï¼ˆçŸ¥é“å¦‚ä½•åˆå¹¶çŠ¶æ€ï¼‰
    state_manager = StateManager(reducer=self.reducer)
    
    # 4. åˆ›å»ºå¯æ‰§è¡Œå¯¹è±¡
    executable_graph = ExecutableGraph(
        nodes=self.nodes,           # èŠ‚ç‚¹å‡½æ•°å­—å…¸
        edges=self.edges,           # è¾¹å®šä¹‰
        entry_point=self.entry_point,  # å…¥å£ç‚¹
        state_manager=state_manager,    # çŠ¶æ€ç®¡ç†å™¨
        execution_plan=execution_plan  # æ‰§è¡Œè®¡åˆ’
    )
    
    return executable_graph
```

### 3.4 ä½¿ç”¨ç¼–è¯‘åçš„ `graph_app`

ç¼–è¯‘åï¼Œä½ å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```python
# 1. åˆ›å»ºåˆå§‹çŠ¶æ€
initial_state = {
    "raw_reviews": [],
    "critical_reviews": [],
    "rag_analysis_results": [],
    "action_plans": [],
    "logs": [],
    "processed_ids": []  # æˆ–è€…ä¿ç•™å†å²ID
}

# 2. è¿è¡Œå·¥ä½œæµï¼ˆæµå¼è¾“å‡ºï¼‰
for event in graph_app.stream(initial_state):
    # event æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œä¾‹å¦‚ï¼š
    # {"monitor": {raw_reviews: [...], logs: [...]}}
    # {"filter": {critical_reviews: [...], logs: [...]}}
    # ...
    for node_name, node_output in event.items():
        print(f"èŠ‚ç‚¹ {node_name} æ‰§è¡Œå®Œæˆï¼Œè¾“å‡º: {node_output}")

# 3. æˆ–è€…ä¸€æ¬¡æ€§è¿è¡Œï¼ˆéæµå¼ï¼‰
final_state = graph_app.invoke(initial_state)
```

### 3.5 ä¸ºä»€ä¹ˆéœ€è¦ `compile()`ï¼Ÿ

**ç±»æ¯”**ï¼š
- **ä¸ç¼–è¯‘**ï¼šå°±åƒæœ‰ä¸€æœ¬"æ“ä½œæ‰‹å†Œ"ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½è¦"ç¿»ä¹¦æŸ¥æ‰¾ä¸‹ä¸€æ­¥"
- **ç¼–è¯‘å**ï¼šå°±åƒæŠŠæ“ä½œæ‰‹å†Œ"èƒŒä¸‹æ¥"ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ›´å¿«æ›´é«˜æ•ˆ

**å®é™…å¥½å¤„**ï¼š
1. **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼–è¯‘æ—¶å¯ä»¥ä¼˜åŒ–æ‰§è¡Œè·¯å¾„
2. **é”™è¯¯æ£€æŸ¥**ï¼šç¼–è¯‘æ—¶å‘ç°å›¾ç»“æ„é”™è¯¯ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶
3. **å¯å¤ç”¨**ï¼šç¼–è¯‘ä¸€æ¬¡ï¼Œå¯ä»¥è¿è¡Œå¤šæ¬¡ï¼ˆ`graph_app` å¯ä»¥é‡å¤ä½¿ç”¨ï¼‰

---

## 4. æ€»ç»“

### 4.1 å…³é”®æ¦‚å¿µå›é¡¾

1. **è¿½åŠ  vs è¦†ç›–**ï¼š
   - `logs` å’Œ `processed_ids` æ˜¯è¿½åŠ çš„ï¼ˆç´¯ç§¯å†å²ï¼‰
   - å…¶ä»–å­—æ®µæ˜¯è¦†ç›–çš„ï¼ˆå½“å‰æ‰¹æ¬¡çš„æ•°æ®ï¼‰

2. **æ•°æ®æµè½¬**ï¼š
   - Monitor â†’ Filter â†’ RAG â†’ Action
   - æ¯ä¸ªèŠ‚ç‚¹è¯»å–ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºï¼Œç”Ÿæˆè‡ªå·±çš„è¾“å‡º

3. **compile() çš„ä½œç”¨**ï¼š
   - æŠŠ"è®¾è®¡å›¾çº¸"ï¼ˆStateGraphï¼‰å˜æˆ"å¯è¿è¡Œçš„æœºå™¨"ï¼ˆgraph_appï¼‰
   - éªŒè¯å›¾ç»“æ„ã€ä¼˜åŒ–æ‰§è¡Œè·¯å¾„ã€åˆ›å»ºæ‰§è¡Œå¼•æ“

### 4.2 ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

1. **è¿è¡Œä»£ç **ï¼šåœ¨ `src/graph.py` çš„ `build_graph()` å‡½æ•°ä¸­æ‰“æ–­ç‚¹ï¼Œè§‚å¯Ÿ `compile()` å‰åçš„å¯¹è±¡å˜åŒ–
2. **ä¿®æ”¹ reducer**ï¼šå°è¯•ä¿®æ”¹ `src/state.py` ä¸­çš„ `reducer`ï¼Œçœ‹çœ‹ä¸åŒåˆå¹¶ç­–ç•¥çš„æ•ˆæœ
3. **æ·»åŠ èŠ‚ç‚¹**ï¼šå°è¯•åœ¨ `src/graph.py` ä¸­æ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œç†è§£å¦‚ä½•æ‰©å±•å·¥ä½œæµ

---

**å¸Œæœ›è¿™ä»½è§£é‡Šå¯¹ä½ æœ‰å¸®åŠ©ï¼å¦‚æœè¿˜æœ‰ç–‘é—®ï¼Œæ¬¢è¿ç»§ç»­æé—®ã€‚** ğŸš€

